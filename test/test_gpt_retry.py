import openai
import os
from dotenv import load_dotenv
from logs import logger
import traceback

from tenacity import (
    retry,
    stop_after_attempt,
    wait_random_exponential,
)  # for exponential backoff

load_dotenv()

openai.api_key = os.getenv("AZURE_OPENAI_KEY")
openai.api_base = os.getenv("AZURE_OPENAI_ENDPOINT")
# logger.debug(f"AZURE_OPENAI_KEY: {AZURE_OPENAI_KEY}")
openai.api_type = "azure"
openai.api_version = os.getenv("AZURE_OPENAI_API_VERSION")
deployment_name = os.getenv("AZURE_OPENAI_DEPLOYMENT")


# @retry(wait=wait_random_exponential(min=1, max=60), stop=stop_after_attempt(6))
@retry(wait=60, stop=stop_after_attempt(1))
def chat_completion_with_backoff(**kwargs):
    return openai.ChatCompletion.create(**kwargs)


def get_gpt_response():
    try:
        # response = openai.ChatCompletion.create(
        #     engine=deployment_name,  # engine = "deployment_name".
        #     messages=messages,
        #     temperature=0,
        #     request_timeout = 300,
        # )
        response = chat_completion_with_backoff(
            engine=deployment_name,  # engine = "deployment_name".
            messages=[
                {
                    "role": "system",
                    "content": "Assistant is a large language model trained by OpenAI.",
                },
                {"role": "user", "content": "写一篇1000字的关于春天的作文"},
                # {"role": "user", "content": "hi"},
            ],
            temperature=0,
            request_timeout=5,
        )

        gpt_response = response["choices"][0]["message"]["content"]
        prompt_tokens = response["usage"]["prompt_tokens"]
        completion_tokens = response["usage"]["completion_tokens"]
        total_tokens = response["usage"]["total_tokens"]
        print(gpt_response)
        return gpt_response, prompt_tokens, completion_tokens, total_tokens
    # except openai.error.Timeout as e:
    #     logger.error("get_gpt_response  Timeout Exception:", str(e))

    except Exception as e:
        # logger.error("get_gpt_response Exception:", str(e))
        logger.exception("get_gpt_response Exception:", e)          
        # logger.warning("======")
        # logger.error("get_gpt_response Exception: {}".format(e))
        # logger.warning("======")
        # logger.error("get_gpt_response Exception: {}".format(traceback.format_exc()))
        return None, None, None, None

messages = [
    {"role": "system", "content": """Analyze the contents from a git commit patch data,and summarize the contents of the commit.\nIf the commit involves more than 1 file, please summarize the contents of each file separately.\nOutput format:\n<path of 1st file>\n\n<summary of 1st file> \n<path of 2nd file>\n\n<summary of 2nd file>\nReplace "article" with "https://learn.microsoft.com/en-us/azure/" in the path of the file.\nIf the path is end with ".md", remove ".md" from the path.\nFor example:\nFor original path "articles/abc/def/ghi.md", the output should be:\nhttps://learn.microsoft.com/en-us/azure/abc/def/ghi.md \n\n(newline twice) This is a summary of the 1st file. \n\n\n Reply in Chinese."""}, 
            {"role": "user", "content": "Here are the commit patch data. ###From 63ab2683fc2api/create-p ###"
             }
            ]

# get_gpt_response()


# response = chat_completion_with_backoff(
#             engine=deployment_name,  # engine = "deployment_name".
#             messages=[
#                 {
#                     "role": "system",
#                     "content": "Assistant is a large language model trained by OpenAI.",
#                 },
#                 {"role": "user", "content": "写一篇1000字的关于春天的作文"},
#                 # {"role": "user", "content": "hi"},
#             ],
#             temperature=0,
#             request_timeout=10,
#         )
# print(response)


content = "Here are the commit patch data. ###From 63ab2683fc245f753d7ecd13152bcf0a95b138f4 Mon Sep 17 00:00:00 2001\nFrom: Nitin Mehrotra <6343641+nitinme@users.noreply.github.com>\nDate: Thu, 16 Nov 2023 17:06:34 -0800\nSubject: [PATCH] Removing the legacy services metadata\n\n---\n articles/ai-services/Anomaly-Detector/How-to/batch-inference.md | 2 +-\n articles/ai-services/Anomaly-Detector/How-to/create-resource.md | 2 +-\n .../How-to/deploy-anomaly-detection-on-container-instances.md   | 2 +-\n .../How-to/deploy-anomaly-detection-on-iot-edge.md              | 2 +-\n .../ai-services/Anomaly-Detector/How-to/identify-anomalies.md   | 2 +-\n articles/ai-services/Anomaly-Detector/How-to/postman.md         | 2 +-\n articles/ai-services/Anomaly-Detector/How-to/prepare-data.md    | 2 +-\n .../ai-services/Anomaly-Detector/How-to/streaming-inference.md  | 2 +-\n articles/ai-services/Anomaly-Detector/How-to/train-model.md     | 2 +-\n .../anomaly-detector-container-configuration.md                 | 2 +-\n .../Anomaly-Detector/anomaly-detector-container-howto.md        | 2 +-\n .../concepts/anomaly-detection-best-practices.md                | 2 +-\n .../Anomaly-Detector/concepts/best-practices-multivariate.md    | 2 +-\n .../Anomaly-Detector/concepts/multivariate-architecture.md      | 2 +-\n articles/ai-services/Anomaly-Detector/concepts/troubleshoot.md  | 2 +-\n .../includes/create-anomaly-detector-resource.md                | 2 +-\n .../ai-services/Anomaly-Detector/includes/mvad-data-schema.md   | 2 +-\n .../ai-services/Anomaly-Detector/includes/mvad-input-params.md  | 2 +-\n .../Anomaly-Detector/includes/quickstart-cleanup-next-steps.md  | 2 +-\n .../anomaly-detector-client-library-csharp-multivariate.md      | 2 +-\n .../quickstarts/anomaly-detector-client-library-csharp.md       | 2 +-\n .../anomaly-detector-client-library-java-multivariate.md        | 2 +-\n .../anomaly-detector-client-library-javascript-multivariate.md  | 2 +-\n .../quickstarts/anomaly-detector-client-library-javascript.md   | 2 +-\n .../anomaly-detector-client-library-python-multivariate.md      | 2 +-\n .../quickstarts/anomaly-detector-client-library-python.md       | 2 +-\n articles/ai-services/Anomaly-Detector/index.yml                 | 2 +-\n articles/ai-services/Anomaly-Detector/overview.md               | 2 +-\n .../quickstarts/client-libraries-multivariate.md                | 2 +-\n .../Anomaly-Detector/quickstarts/client-libraries.md            | 2 +-\n articles/ai-services/Anomaly-Detector/regions.md                | 2 +-\n articles/ai-services/Anomaly-Detector/service-limits.md         | 2 +-\n .../Anomaly-Detector/tutorials/azure-data-explorer.md           | 2 +-\n .../tutorials/batch-anomaly-detection-powerbi.md                | 2 +-\n .../tutorials/multivariate-anomaly-detection-synapse.md         | 2 +-\n articles/ai-services/LUIS/concepts/application-design.md        | 2 +-\n articles/ai-services/LUIS/concepts/entities.md                  | 2 +-\n articles/ai-services/LUIS/concepts/intents.md                   | 2 +-\n articles/ai-services/LUIS/concepts/patterns-features.md         | 2 +-\n articles/ai-services/LUIS/get-started-get-model-rest-apis.md    | 2 +-\n articles/ai-services/LUIS/howto-add-prebuilt-models.md          | 2 +-\n .../ai-services/LUIS/includes/add-prediction-resource-portal.md | 2 +-\n articles/ai-services/LUIS/includes/best-practice-utterances.md  | 2 +-\n articles/ai-services/LUIS/includes/caution-authoring-key.md     | 2 +-\n .../ai-services/LUIS/includes/chinese-language-support-notes.md | 2 +-\n articles/ai-services/LUIS/includes/deprecation-notice.md        | 2 +-\n .../LUIS/includes/get-started-get-model-create-pizza-app.md     | 2 +-\n .../includes/get-started-get-model-json-example-utterances.md   | 2 +-\n .../LUIS/includes/get-started-get-model-rest-csharp.md          | 2 +-\n .../ai-services/LUIS/includes/get-started-get-model-rest-go.md  | 2 +-\n .../LUIS/includes/get-started-get-model-rest-java.md            | 2 +-\n .../LUIS/includes/get-started-get-model-rest-nodejs.md          | 2 +-\n .../LUIS/includes/get-started-get-model-rest-python.md          | 2 +-\n articles/ai-services/LUIS/includes/how-to-label.md              | 2 +-\n articles/ai-services/LUIS/includes/howto-publish.md             | 2 +-\n articles/ai-services/LUIS/includes/howto-train.md               | 2 +-\n .../LUIS/includes/manage-contributors-authoring-resource.md     | 2 +-\n articles/ai-services/LUIS/includes/portal-consolidation.md      | 2 +-\n articles/ai-services/LUIS/includes/rest-api.md                  | 2 +-\n articles/ai-services/LUIS/includes/sdk-code-examples.md         | 2 +-\n articles/ai-services/LUIS/includes/sdk-csharp.md                | 2 +-\n articles/ai-services/LUIS/includes/sdk-json.md                  | 2 +-\n articles/ai-services/LUIS/includes/sdk-nodejs.md                | 2 +-\n articles/ai-services/LUIS/includes/sdk-python.md                | 2 +-\n articles/ai-services/LUIS/includes/sign-in-process.md           | 2 +-\n articles/ai-services/LUIS/includes/switch-azure-directories.md  | 2 +-\n .../ai-services/LUIS/includes/text-analytics-support-notes.md   | 2 +-\n articles/ai-services/LUIS/includes/v3-prediction-endpoint.md    | 2 +-\n articles/ai-services/LUIS/includes/wait-v3-upgrade.md           | 2 +-\n articles/ai-services/LUIS/index.yml                             | 2 +-\n articles/ai-services/LUIS/luis-concept-data-conversion.md       | 2 +-\n articles/ai-services/LUIS/luis-concept-data-storage.md          | 2 +-\n articles/ai-services/LUIS/luis-concept-prebuilt-model.md        | 2 +-\n articles/ai-services/LUIS/luis-container-configuration.md       | 2 +-\n articles/ai-services/LUIS/luis-container-howto.md               | 2 +-\n articles/ai-services/LUIS/luis-container-limitations.md         | 2 +-\n articles/ai-services/LUIS/luis-how-to-azure-subscription.md     | 2 +-\n articles/ai-services/LUIS/luis-how-to-batch-test.md             | 2 +-\n articles/ai-services/LUIS/luis-how-to-collaborate.md            | 2 +-\n articles/ai-services/LUIS/luis-how-to-manage-versions.md        | 2 +-\n articles/ai-services/LUIS/luis-how-to-model-intent-pattern.md   | 2 +-\n articles/ai-services/LUIS/luis-how-to-use-dashboard.md          | 2 +-\n articles/ai-services/LUIS/luis-language-support.md              | 2 +-\n articles/ai-services/LUIS/luis-migration-api-v1-to-v2.md        | 2 +-\n articles/ai-services/LUIS/luis-migration-authoring.md           | 2 +-\n articles/ai-services/LUIS/luis-reference-prebuilt-age.md        | 2 +-\n articles/ai-services/LUIS/luis-reference-prebuilt-currency.md   | 2 +-\n articles/ai-services/LUIS/luis-reference-prebuilt-datetimev2.md | 2 +-\n articles/ai-services/LUIS/luis-reference-prebuilt-deprecated.md | 2 +-\n articles/ai-services/LUIS/luis-reference-prebuilt-dimension.md  | 2 +-\n articles/ai-services/LUIS/luis-reference-prebuilt-domains.md    | 2 +-\n articles/ai-services/LUIS/luis-reference-prebuilt-email.md      | 2 +-\n articles/ai-services/LUIS/luis-reference-prebuilt-entities.md   | 2 +-\n .../ai-services/LUIS/luis-reference-prebuilt-geographyV2.md     | 2 +-\n articles/ai-services/LUIS/luis-reference-prebuilt-keyphrase.md  | 2 +-\n articles/ai-services/LUIS/luis-reference-prebuilt-number.md     | 2 +-\n articles/ai-services/LUIS/luis-reference-prebuilt-ordinal-v2.md | 2 +-\n articles/ai-services/LUIS/luis-reference-prebuilt-ordinal.md    | 2 +-\n articles/ai-services/LUIS/luis-reference-prebuilt-percentage.md | 2 +-\n articles/ai-services/LUIS/luis-reference-prebuilt-person.md     | 2 +-\n .../ai-services/LUIS/luis-reference-prebuilt-phonenumber.md     | 2 +-\n articles/ai-services/LUIS/luis-reference-prebuilt-sentiment.md  | 2 +-\n .../ai-services/LUIS/luis-reference-prebuilt-temperature.md     | 2 +-\n articles/ai-services/LUIS/luis-reference-prebuilt-url.md        | 2 +-\n articles/ai-services/LUIS/luis-reference-response-codes.md      | 2 +-\n articles/ai-services/LUIS/luis-traffic-manager.md               | 2 +-\n articles/ai-services/LUIS/luis-tutorial-bing-spellcheck.md      | 2 +-\n .../LUIS/luis-tutorial-node-import-utterances-csv.md            | 2 +-\n articles/ai-services/LUIS/luis-user-privacy.md                  | 2 +-\n .../ai-services/LUIS/reference-entity-machine-learned-entity.md | 2 +-\n articles/ai-services/LUIS/reference-entity-pattern-any.md       | 2 +-\n articles/ai-services/LUIS/reference-entity-simple.md            | 2 +-\n articles/ai-services/authentication.md                          | 2 +-\n articles/ai-services/cognitive-services-container-support.md    | 2 +-\n articles/ai-services/cognitive-services-custom-subdomains.md    | 2 +-\n .../ai-services/cognitive-services-environment-variables.md     | 2 +-\n articles/ai-services/cognitive-services-limited-access.md       | 2 +-\n articles/ai-services/cognitive-services-support-options.md      | 2 +-\n articles/ai-services/cognitive-services-virtual-networks.md     | 2 +-\n articles/ai-services/computer-vision/Category-Taxonomy.md       | 2 +-\n .../computer-vision/Tutorials/storage-lab-tutorial.md           | 2 +-\n .../computer-vision-how-to-install-containers.md                | 2 +-\n .../computer-vision-resource-container-config.md                | 2 +-\n .../ai-services/computer-vision/concept-background-removal.md   | 2 +-\n articles/ai-services/computer-vision/concept-brand-detection.md | 2 +-\n .../ai-services/computer-vision/concept-categorizing-images.md  | 2 +-\n .../ai-services/computer-vision/concept-describe-images-40.md   | 2 +-\n .../ai-services/computer-vision/concept-describing-images.md    | 2 +-\n .../computer-vision/concept-detecting-adult-content.md          | 2 +-\n .../computer-vision/concept-detecting-color-schemes.md          | 2 +-\n .../computer-vision/concept-detecting-domain-content.md         | 2 +-\n articles/ai-services/computer-vision/concept-detecting-faces.md | 2 +-\n .../computer-vision/concept-detecting-image-types.md            | 2 +-\n articles/ai-services/computer-vision/concept-face-detection.md  | 2 +-\n .../computer-vision/concept-face-recognition-data-structures.md | 2 +-\n .../ai-services/computer-vision/concept-face-recognition.md     | 2 +-\n .../computer-vision/concept-generate-thumbnails-40.md           | 2 +-\n .../computer-vision/concept-generating-thumbnails.md            | 2 +-\n articles/ai-services/computer-vision/concept-image-retrieval.md | 2 +-\n .../computer-vision/concept-liveness-abuse-monitoring.md        | 2 +-\n .../ai-services/computer-vision/concept-model-customization.md  | 2 +-\n .../ai-services/computer-vision/concept-object-detection-40.md  | 2 +-\n .../ai-services/computer-vision/concept-object-detection.md     | 2 +-\n articles/ai-services/computer-vision/concept-ocr.md             | 2 +-\n .../ai-services/computer-vision/concept-people-detection.md     | 2 +-\n articles/ai-services/computer-vision/concept-shelf-analysis.md  | 2 +-\n articles/ai-services/computer-vision/concept-tag-images-40.md   | 2 +-\n articles/ai-services/computer-vision/concept-tagging-images.md  | 2 +-\n .../computer-vision/deploy-computer-vision-on-premises.md       | 2 +-\n articles/ai-services/computer-vision/faq.yml                    | 2 +-\n articles/ai-services/computer-vision/how-to/add-faces.md        | 2 +-\n articles/ai-services/computer-vision/how-to/analyze-video.md    | 2 +-\n .../ai-services/computer-vision/how-to/background-removal.md    | 2 +-\n .../ai-services/computer-vision/how-to/blob-storage-search.md   | 2 +-\n .../ai-services/computer-vision/how-to/call-analyze-image-40.md | 2 +-\n .../ai-services/computer-vision/how-to/call-analyze-image.md    | 2 +-\n articles/ai-services/computer-vision/how-to/call-read-api.md    | 2 +-\n .../ai-services/computer-vision/how-to/coco-verification.md     | 2 +-\n .../ai-services/computer-vision/how-to/find-similar-faces.md    | 2 +-\n .../ai-services/computer-vision/how-to/generate-thumbnail.md    | 2 +-\n .../ai-services/computer-vision/how-to/identity-access-token.md | 2 +-\n .../ai-services/computer-vision/how-to/identity-detect-faces.md | 2 +-\n articles/ai-services/computer-vision/how-to/image-retrieval.md  | 2 +-\n .../computer-vision/how-to/migrate-from-custom-vision.md        | 2 +-\n articles/ai-services/computer-vision/how-to/mitigate-latency.md | 2 +-\n .../ai-services/computer-vision/how-to/model-customization.md   | 2 +-\n .../computer-vision/how-to/specify-detection-model.md           | 2 +-\n .../computer-vision/how-to/specify-recognition-model.md         | 2 +-\n articles/ai-services/computer-vision/how-to/use-large-scale.md  | 2 +-\n .../ai-services/computer-vision/how-to/use-persondirectory.md   | 2 +-\n articles/ai-services/computer-vision/how-to/video-retrieval.md  | 2 +-\n articles/ai-services/computer-vision/identity-api-reference.md  | 2 +-\n articles/ai-services/computer-vision/includes/coco-files.md     | 2 +-\n .../includes/container-requirements-and-recommendations.md      | 2 +-\n .../ai-services/computer-vision/includes/curl-quickstart.md     | 2 +-\n articles/ai-services/computer-vision/includes/find-key.md       | 2 +-\n .../computer-vision/includes/identity-curl-quickstart.md        | 2 +-\n .../computer-vision/includes/identity-data-notice.md            | 2 +-\n .../computer-vision/includes/identity-gate-notice.md            | 2 +-\n .../computer-vision/includes/identity-input-composition.md      | 2 +-\n .../computer-vision/includes/identity-input-detection.md        | 2 +-\n .../computer-vision/includes/identity-input-technical.md        | 2 +-\n .../computer-vision/includes/identity-sensitive-attributes.md   | 2 +-\n .../computer-vision/includes/identity-studio-quickstart.md      | 2 +-\n .../includes/image-analysis-curl-quickstart-40.md               | 2 +-\n .../computer-vision/includes/image-analysis-curl-quickstart.md  | 2 +-\n .../includes/image-analysis-studio-quickstart.md                | 2 +-\n .../computer-vision/includes/image-analysis-versions.md         | 2 +-\n .../ai-services/computer-vision/includes/liveness-sdk-gate.md   | 2 +-\n .../computer-vision/includes/ocr-studio-quickstart.md           | 2 +-\n .../computer-vision/includes/quickstarts-sdk/csharp-sdk.md      | 2 +-\n .../includes/quickstarts-sdk/identity-csharp-sdk.md             | 2 +-\n .../includes/quickstarts-sdk/identity-javascript-sdk.md         | 2 +-\n .../includes/quickstarts-sdk/identity-python-sdk.md             | 2 +-\n .../includes/quickstarts-sdk/image-analysis-cpp-sdk-40.md       | 2 +-\n .../includes/quickstarts-sdk/image-analysis-csharp-sdk-40.md    | 2 +-\n .../includes/quickstarts-sdk/image-analysis-csharp-sdk.md       | 2 +-\n .../includes/quickstarts-sdk/image-analysis-java-sdk-40.md      | 2 +-\n .../includes/quickstarts-sdk/image-analysis-java-sdk.md         | 2 +-\n .../includes/quickstarts-sdk/image-analysis-node-sdk.md         | 2 +-\n .../includes/quickstarts-sdk/image-analysis-python-sdk-40.md    | 2 +-\n .../includes/quickstarts-sdk/image-analysis-python-sdk.md       | 2 +-\n .../computer-vision/includes/quickstarts-sdk/node-sdk.md        | 2 +-\n .../computer-vision/includes/quickstarts-sdk/python-sdk.md      | 2 +-\n articles/ai-services/computer-vision/includes/read-editions.md  | 2 +-\n articles/ai-services/computer-vision/index-spatial-analysis.yml | 2 +-\n articles/ai-services/computer-vision/index.yml                  | 2 +-\n .../computer-vision/intro-to-spatial-analysis-public-preview.md | 2 +-\n articles/ai-services/computer-vision/language-support.md        | 2 +-\n articles/ai-services/computer-vision/overview-image-analysis.md | 2 +-\n articles/ai-services/computer-vision/overview-ocr.md            | 2 +-\n articles/ai-services/computer-vision/overview.md                | 2 +-\n .../computer-vision/quickstarts-sdk/client-library.md           | 2 +-\n .../computer-vision/quickstarts-sdk/identity-client-library.md  | 2 +-\n .../quickstarts-sdk/image-analysis-client-library-40.md         | 2 +-\n .../quickstarts-sdk/image-analysis-client-library.md            | 2 +-\n .../computer-vision/read-container-migration-guide.md           | 2 +-\n articles/ai-services/computer-vision/reference-video-search.md  | 2 +-\n articles/ai-services/computer-vision/sdk/install-sdk.md         | 2 +-\n articles/ai-services/computer-vision/sdk/overview-sdk.md        | 2 +-\n .../computer-vision/spatial-analysis-camera-placement.md        | 2 +-\n .../ai-services/computer-vision/spatial-analysis-container.md   | 2 +-\n articles/ai-services/computer-vision/spatial-analysis-local.md  | 2 +-\n .../ai-services/computer-vision/spatial-analysis-logging.md     | 2 +-\n .../ai-services/computer-vision/spatial-analysis-operations.md  | 2 +-\n .../ai-services/computer-vision/spatial-analysis-web-app.md     | 2 +-\n .../computer-vision/spatial-analysis-zone-line-placement.md     | 2 +-\n articles/ai-services/computer-vision/upgrade-api-versions.md    | 2 +-\n articles/ai-services/computer-vision/use-case-alt-text.md       | 2 +-\n articles/ai-services/computer-vision/use-case-dwell-time.md     | 2 +-\n .../computer-vision/use-case-identity-verification.md           | 2 +-\n articles/ai-services/computer-vision/use-case-queue-time.md     | 2 +-\n articles/ai-services/computer-vision/vehicle-analysis.md        | 2 +-\n articles/ai-services/computer-vision/whats-new.md               | 2 +-\n .../ai-services/containers/azure-container-instance-recipe.md   | 2 +-\n articles/ai-services/containers/azure-kubernetes-recipe.md      | 2 +-\n articles/ai-services/containers/container-faq.yml               | 2 +-\n articles/ai-services/containers/container-reuse-recipe.md       | 2 +-\n articles/ai-services/containers/disconnected-container-faq.yml  | 2 +-\n articles/ai-services/containers/disconnected-containers.md      | 2 +-\n articles/ai-services/containers/docker-compose-recipe.md        | 2 +-\n .../includes/cognitive-services-container-security.md           | 2 +-\n .../containers/includes/cognitive-services-faq-note.md          | 2 +-\n .../containers/includes/configure-disconnected-container.md     | 2 +-\n .../includes/container-gathering-required-parameters.md         | 2 +-\n .../containers/includes/container-preview-prerequisites.md      | 2 +-\n articles/ai-services/containers/includes/create-aks-resource.md | 2 +-\n .../create-container-instances-resource-from-azure-cli.md       | 2 +-\n .../containers/includes/create-container-instances-resource.md  | 2 +-\n .../ai-services/containers/includes/diagnostics-container.md    | 2 +-\n articles/ai-services/containers/includes/image-location-note.md | 2 +-\n articles/ai-services/content-moderator/api-reference.md         | 2 +-\n articles/ai-services/content-moderator/client-libraries.md      | 2 +-\n articles/ai-services/content-moderator/export-delete-data.md    | 2 +-\n .../content-moderator/image-lists-quickstart-dotnet.md          | 2 +-\n articles/ai-services/content-moderator/image-moderation-api.md  | 2 +-\n .../content-moderator/includes/quickstarts/csharp-sdk.md        | 2 +-\n .../content-moderator/includes/quickstarts/java-sdk.md          | 2 +-\n .../content-moderator/includes/quickstarts/python-sdk.md        | 2 +-\n .../content-moderator/includes/quickstarts/rest-api.md          | 2 +-\n .../ai-services/content-moderator/includes/tool-deprecation.md  | 2 +-\n articles/ai-services/content-moderator/index.yml                | 2 +-\n articles/ai-services/content-moderator/language-support.md      | 2 +-\n articles/ai-services/content-moderator/overview.md              | 2 +-\n articles/ai-services/content-moderator/samples-dotnet.md        | 2 +-\n articles/ai-services/content-moderator/samples-rest.md          | 2 +-\n .../content-moderator/term-lists-quickstart-dotnet.md           | 2 +-\n articles/ai-services/content-moderator/text-moderation-api.md   | 2 +-\n articles/ai-services/content-moderator/try-image-api.md         | 2 +-\n articles/ai-services/content-moderator/try-image-list-api.md    | 2 +-\n articles/ai-services/content-moderator/try-terms-list-api.md    | 2 +-\n articles/ai-services/content-moderator/try-text-api.md          | 2 +-\n articles/ai-services/content-moderator/video-moderation-api.md  | 2 +-\n articles/ai-services/content-safety/concepts/harm-categories.md | 2 +-\n .../ai-services/content-safety/concepts/jailbreak-detection.md  | 2 +-\n articles/ai-services/content-safety/concepts/response-codes.md  | 2 +-\n articles/ai-services/content-safety/how-to/use-blocklist.md     | 2 +-\n articles/ai-services/content-safety/includes/env-vars.md        | 2 +-\n .../includes/quickstarts/csharp-quickstart-image.md             | 2 +-\n .../includes/quickstarts/csharp-quickstart-text.md              | 2 +-\n .../includes/quickstarts/java-quickstart-image.md               | 2 +-\n .../content-safety/includes/quickstarts/java-quickstart-text.md | 2 +-\n .../includes/quickstarts/javascript-quickstart-image.md         | 2 +-\n .../includes/quickstarts/javascript-quickstart-text.md          | 2 +-\n .../includes/quickstarts/python-quickstart-image.md             | 2 +-\n .../includes/quickstarts/python-quickstart-text.md              | 2 +-\n .../includes/quickstarts/rest-quickstart-image.md               | 2 +-\n .../content-safety/includes/quickstarts/rest-quickstart-text.md | 2 +-\n articles/ai-services/content-safety/index.yml                   | 2 +-\n articles/ai-services/content-safety/language-support.md         | 2 +-\n articles/ai-services/content-safety/overview.md                 | 2 +-\n articles/ai-services/content-safety/quickstart-image.md         | 2 +-\n articles/ai-services/content-safety/quickstart-text.md          | 2 +-\n articles/ai-services/content-safety/studio-quickstart.md        | 2 +-\n articles/ai-services/content-safety/whats-new.md                | 2 +-\n articles/ai-services/create-account-bicep.md                    | 2 +-\n .../ai-services/create-account-resource-manager-template.md     | 2 +-\n articles/ai-services/create-account-terraform.md                | 2 +-\n .../custom-vision-service/custom-vision-onnx-windows-ml.md      | 2 +-\n .../ai-services/custom-vision-service/export-delete-data.md     | 2 +-\n .../ai-services/custom-vision-service/export-model-python.md    | 2 +-\n .../custom-vision-service/export-programmatically.md            | 2 +-\n articles/ai-services/custom-vision-service/export-your-model.md | 2 +-\n articles/ai-services/custom-vision-service/faq.yml              | 2 +-\n .../custom-vision-service/get-started-build-detector.md         | 2 +-\n .../custom-vision-service/getting-started-build-a-classifier.md | 2 +-\n .../getting-started-improving-your-classifier.md                | 2 +-\n articles/ai-services/custom-vision-service/includes/find-key.md | 2 +-\n articles/ai-services/custom-vision-service/index.yml            | 2 +-\n .../custom-vision-service/iot-visual-alerts-tutorial.md         | 2 +-\n articles/ai-services/custom-vision-service/limits-and-quotas.md | 2 +-\n .../ai-services/custom-vision-service/logo-detector-mobile.md   | 2 +-\n articles/ai-services/custom-vision-service/overview.md          | 2 +-\n articles/ai-services/custom-vision-service/release-notes.md     | 2 +-\n articles/ai-services/custom-vision-service/select-domain.md     | 2 +-\n articles/ai-services/custom-vision-service/suggested-tags.md    | 2 +-\n articles/ai-services/custom-vision-service/test-your-model.md   | 2 +-\n .../custom-vision-service/update-application-to-3.0-sdk.md      | 2 +-\n articles/ai-services/custom-vision-service/whats-new.md         | 2 +-\n articles/ai-services/diagnostic-logging.md                      | 2 +-\n articles/ai-services/disable-local-auth.md                      | 2 +-\n articles/ai-services/document-intelligence/service-limits.md    | 2 +-\n .../immersive-reader/how-to-create-immersive-reader.md          | 2 +-\n .../immersive-reader/how-to-customize-launch-button.md          | 2 +-\n .../ai-services/immersive-reader/how-to/set-cookie-policy.md    | 2 +-\n .../quickstarts/immersive-reader-client-library-csharp.md       | 2 +-\n .../quickstarts/immersive-reader-client-library-java-android.md | 2 +-\n .../quickstarts/immersive-reader-client-library-kotlin.md       | 2 +-\n .../quickstarts/immersive-reader-client-library-nodejs.md       | 2 +-\n .../quickstarts/immersive-reader-client-library-swift.md        | 2 +-\n articles/ai-services/immersive-reader/language-support.md       | 2 +-\n articles/ai-services/immersive-reader/overview.md               | 2 +-\n .../immersive-reader/quickstarts/client-libraries.md            | 2 +-\n articles/ai-services/immersive-reader/reference.md              | 2 +-\n articles/ai-services/immersive-reader/release-notes.md          | 2 +-\n .../immersive-reader/security-how-to-update-role-assignment.md  | 2 +-\n .../immersive-reader/tutorial-ios-picture-immersive-reader.md   | 2 +-\n .../ai-services/includes/cognitive-services-about-encryption.md | 2 +-\n .../ai-services/includes/configure-customer-managed-keys.md     | 2 +-\n articles/ai-services/includes/key-vault-cli-authentication.md   | 2 +-\n articles/ai-services/includes/luis-qnamaker-shared-concept.md   | 2 +-\n .../ai-services/includes/quickstarts/contributor-requirement.md | 2 +-\n .../includes/quickstarts/create-decision-resource-portal.md     | 2 +-\n .../includes/quickstarts/create-language-resource-portal.md     | 2 +-\n .../ai-services/includes/quickstarts/create-resource-group.md   | 2 +-\n .../includes/quickstarts/create-service-principal.md            | 2 +-\n .../includes/quickstarts/create-vision-resource-portal.md       | 2 +-\n articles/ai-services/includes/quickstarts/management-azcli.md   | 2 +-\n .../ai-services/includes/quickstarts/management-azportal.md     | 2 +-\n .../ai-services/includes/quickstarts/management-azpowershell.md | 2 +-\n articles/ai-services/includes/quickstarts/management-csharp.md  | 2 +-\n articles/ai-services/includes/quickstarts/management-java.md    | 2 +-\n articles/ai-services/includes/quickstarts/management-node.md    | 2 +-\n articles/ai-services/includes/quickstarts/management-python.md  | 2 +-\n articles/ai-services/includes/quickstarts/sku-pricing.md        | 2 +-\n articles/ai-services/includes/quickstarts/terms-azure-portal.md | 2 +-\n articles/ai-services/includes/rebrand-note.md                   | 2 +-\n .../language-service/concepts/configure-containers.md           | 2 +-\n .../concepts/custom-features/multi-region-deployment.md         | 2 +-\n .../concepts/custom-features/project-versioning.md              | 2 +-\n articles/ai-services/language-service/concepts/data-limits.md   | 2 +-\n .../ai-services/language-service/concepts/developer-guide.md    | 2 +-\n .../ai-services/language-service/concepts/language-support.md   | 2 +-\n .../concepts/migrate-language-service-latest.md                 | 2 +-\n .../ai-services/language-service/concepts/model-lifecycle.md    | 2 +-\n .../language-service/concepts/multilingual-emoji-support.md     | 2 +-\n .../ai-services/language-service/concepts/previous-updates.md   | 2 +-\n .../ai-services/language-service/concepts/regional-support.md   | 2 +-\n .../language-service/concepts/role-based-access-control.md      | 2 +-\n .../ai-services/language-service/concepts/use-asynchronously.md | 2 +-\n .../concepts/app-architecture.md                                | 2 +-\n .../concepts/best-practices.md                                  | 2 +-\n .../concepts/data-formats.md                                    | 2 +-\n .../concepts/entity-components.md                               | 2 +-\n .../concepts/evaluation-metrics.md                              | 2 +-\n .../concepts/multiple-languages.md                              | 2 +-\n .../concepts/none-intent.md                                     | 2 +-\n .../conversational-language-understanding/faq.md                | 2 +-\n .../conversational-language-understanding/glossary.md           | 2 +-\n .../how-to/build-schema.md                                      | 2 +-\n .../conversational-language-understanding/how-to/call-api.md    | 2 +-\n .../how-to/create-project.md                                    | 2 +-\n .../how-to/deploy-model.md                                      | 2 +-\n .../conversational-language-understanding/how-to/fail-over.md   | 2 +-\n .../how-to/migrate-from-luis.md                                 | 2 +-\n .../how-to/tag-utterances.md                                    | 2 +-\n .../conversational-language-understanding/how-to/train-model.md | 2 +-\n .../how-to/view-model-evaluation.md                             | 2 +-\n .../includes/balance-training-data.md                           | 2 +-\n .../includes/get-keys-endpoint-azure.md                         | 2 +-\n .../includes/label-data-best-practices.md                       | 2 +-\n .../includes/language-studio/assign-resources.md                | 2 +-\n .../includes/language-studio/cancel-training.md                 | 2 +-\n .../includes/language-studio/create-project.md                  | 2 +-\n .../includes/language-studio/delete-deployment.md               | 2 +-\n .../includes/language-studio/delete-model.md                    | 2 +-\n .../includes/language-studio/delete-project.md                  | 2 +-\n .../includes/language-studio/deploy-model.md                    | 2 +-\n .../includes/language-studio/get-prediction-url.md              | 2 +-\n .../includes/language-studio/import-project.md                  | 2 +-\n .../includes/language-studio/load-export-model.md               | 2 +-\n .../includes/language-studio/model-performance.md               | 2 +-\n .../includes/language-studio/project-details.md                 | 2 +-\n .../includes/language-studio/sign-in-studio.md                  | 2 +-\n .../includes/language-studio/swap-deployment.md                 | 2 +-\n .../includes/language-studio/test-model.md                      | 2 +-\n .../includes/language-studio/train-model.md                     | 2 +-\n .../includes/language-studio/unassign-resources.md              | 2 +-\n .../includes/quickstarts/language-studio.md                     | 2 +-\n .../includes/quickstarts/rest-api.md                            | 2 +-\n .../includes/resource-creation-azure-portal.md                  | 2 +-\n .../includes/resource-creation-language-studio.md               | 2 +-\n .../includes/rest-api/assign-resources.md                       | 2 +-\n .../includes/rest-api/create-p ### Reply in Chinese"



import toml
with open('prompts.toml', 'r') as f:
    data = toml.load(f)

# gpt_summary_prompt = data['gpt_summary_prompt_v1']['prompt']
# gpt_title_prompt = data['gpt_title_prompt_v1']['prompt']

gpt_summary_prompt = data['gpt_summary_prompt_v2']['prompt']
gpt_title_prompt = data['gpt_title_prompt_v2']['prompt']

response = chat_completion_with_backoff(
            engine=deployment_name,  # engine = "deployment_name".
            messages=[
                {
                    "role": "system",
                    "content": gpt_summary_prompt,
                },
                {"role": "user", "content": content},
                # {"role": "user", "content": "hi"},
            ],
            temperature=0,
            request_timeout=100,
            max_tokens=1000,
        )
print(response)